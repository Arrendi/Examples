---
output:
  md_document:
    variant: markdown_github
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r init}
base::date()
packageVersion("replyr")
suppressPackageStartupMessages(library("dplyr"))
packageVersion("dplyr")
packageVersion("sparklyr")
devtools::session_info()

sc <- NULL

sc <- sparklyr::spark_connect(version='2.0.2', 
                              master = "local")

print(sc)

mtcars2 <- mtcars %>%
  mutate(car = row.names(mtcars)) 


tempNameGenerator <- replyr::makeTempNameGenerator("TESTTABS")
```

Here is a local run showing the process working (note: this is not definative for a number of reasons including using different row-binding strategies depending on the declared back-end).

```{r runlocally}
for(i in seq_len(100)) {
  print(paste('start',i,base::date()))
  localRes <- mtcars2 %>%
    replyr::replyr_moveValuesToRows(nameForNewKeyColumn= 'fact', 
                                    nameForNewValueColumn= 'value', 
                                    columnsToTakeFrom= colnames(mtcars),
                                    tempNameGenerator = tempNameGenerator) %>%
    collect() %>%
    as.data.frame()
  print(paste(' done',i,base::date()))
}
```


Seems to reliably hang `Spark` (in about 5 passes through the loop on average), sometimes crashing `R`.

Try to run on `Spark`.

```{r issue, eval=FALSE}
mtcars2 <- copy_to(sc, mtcars2, 'mtcars2')

for(i in seq_len(100)) {
  print(paste('start',i,base::date()))
  localRes <- mtcars2 %>%
    replyr::replyr_moveValuesToRows(nameForNewKeyColumn= 'fact', 
                                    nameForNewValueColumn= 'value', 
                                    columnsToTakeFrom= colnames(mtcars),
                                    tempNameGenerator = tempNameGenerator) %>%
    collect() %>%
    as.data.frame()
  print(paste(' done',i,base::date()))
}
```

![](crash.png)


```{r cleanup}
if(!is.null(sc)) {
  sparklyr::spark_disconnect(sc)
}
rm(list=ls())
gc()
```
