---
title: "CalcBehavior"
output: html_document
---


```{r}
library('polynom')
library('ggplot2')


# y_i = 1 with probability x, 0 otherwise
# k = # of groups
# n = # of examples
# B logistic regresion solution to y ~ 0 + est
# est formed different ways
set.seed(23225)
k <- 2
n <- 7
probOn <- polynomial(c(0,1))
gGroups <- paste('g',1:k,sep='')
d <- data.frame(group=sample(gGroups,n,replace=TRUE),
                one=1,
                y=FALSE,
                stringsAsFactors=FALSE)
dTest <- data.frame(group=gGroups,
                    stringsAsFactors=FALSE)

ests <- function(d) {
  num <- aggregate(y~group,data=d,FUN=sum)
  den <- aggregate(one~group,data=d,FUN=sum)
  est <- num$y/den$one
  names(est) <- num$group
  est
}

naiveEst <- function(d) {
  est <- ests(d)
  as.numeric(est[d$group])
}

jackknifeEst <- function(d,jackDenom=1) {
  num <- aggregate(y~group,data=d,FUN=sum)
  numM <- num$y
  names(numM) <- num$group
  numV <- numM[d$group]
  den <- aggregate(one~group,data=d,FUN=sum)
  denM <- den$one
  names(denM) <- den$group
  denV <- denM[d$group]
  v <- as.numeric((numV-d$y/jackDenom)/(denV-1/jackDenom))
  v[is.na(v)|is.infinite(v)|is.nan(v)] <- 0
  v
}


estimateExpectedPrediction <- function(d,dTest) {
  if(all(d$y)) {
    return(1)
  }
  if(all(!d$y)) {
    return(0)
  }
  m <- glm(y~0+est,data=d,family=binomial(link='logit'))
  dTest$pred <- predict(m,newdata=dTest,type='response')
  return(mean(dTest$pred))
}

ys <- expand.grid( rep( list(0:1), n))==1
nPredEst <- 0
jPredEst <- 0
jPredEst2 <- 0
for(ii in seq_len(nrow(ys))) {
  y <- as.logical(ys[ii,])
  d$y <- y
  py <- probOn^(sum(y))*(1-probOn)^(length(y)-sum(y))
  est <- ests(d)
  dTest$est <- as.numeric(est[dTest$group])
  d$est <- naiveEst(d)
  nPred <- estimateExpectedPrediction(d,dTest)
  nPredEst <- nPredEst + nPred*py
  d$est <- jackknifeEst(d,1)
  jPred <- estimateExpectedPrediction(d,dTest)
  jPredEst <- jPredEst + jPred*py
  d$est <- jackknifeEst(d,2)
  jPred2 <- estimateExpectedPrediction(d,dTest)
  jPredEst2 <- jPredEst2 + jPred2*py
}

print('naive prediction')
print(nPredEst)

print('jackknife prediction')
print(jPredEst)

print('jackknife 2 prediction')
print(jPredEst2)

print('ideal prediction')
print(probOn)

plotD <- data.frame(x=seq(0,1,by=0.01),
                    stringsAsFactors = FALSE)
plotD1 <- plotD
plotD1$what <- 'IdealPrediction'
plotD1$est <- as.function(probOn)(plotD$x)
plotD2 <- plotD
plotD2$what <- 'naive prediction'
plotD2$est <- as.function(nPredEst)(plotD$x)
plotD3 <- plotD
plotD3$what <- 'jackknife prediction'
plotD3$est <- as.function(jPredEst)(plotD$x)
plotD4 <- plotD
plotD4$what <- 'jackknife 2 prediction'
plotD4$est <- as.function(jPredEst2)(plotD$x)
plotD <- rbind(plotD1,plotD2,plotD3,plotD4)

ggplot(data=plotD,mapping=aes(x=x,y=est,color=what)) +
  geom_line() + geom_point(alpha=0.5) +
  ggtitle(paste('predictions, n=',n))



plotR <- data.frame(x=seq(0,1,by=0.01),
                    stringsAsFactors = FALSE)
plotR1 <- plotR
plotR1$what <- 'IdealPrediction'
plotR1$ratio <- as.function(probOn)(plotR$x)
plotR2 <- plotR
plotR2$what <- 'naive prediction'
plotR2$ratio <- as.function(nPredEst)(plotR$x)/plotR1$ratio
plotR3 <- plotR
plotR3$what <- 'jackknife prediction'
plotR3$ratio <- as.function(jPredEst)(plotR$x)/plotR1$ratio
plotR4 <- plotR
plotR4$what <- 'jackknife 2 prediction'
plotR4$ratio <- as.function(jPredEst2)(plotR$x)/plotR1$ratio
plotR1$ratio <- 1
plotR <- rbind(plotR1,plotR2,plotR3,plotR4)

ggplot(data=plotR,mapping=aes(x=x,y=ratio,color=what)) +
  geom_line() + geom_point(alpha=0.5) +
  ggtitle(paste('prediction ratios, n=',n))

```

