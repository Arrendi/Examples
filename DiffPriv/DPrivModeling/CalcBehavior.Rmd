---
title: "CalcBehavior"
output: html_document
---


```{r}
library('polynom')
library('ggplot2')


# y_i = 1 with probability x, 0 otherwise
# k = # of groups
# n = # of examples
# B logistic regresion solution to y ~ 0 + est
# est formed different ways
set.seed(23225)
k <- 2
n <- 7
probOn <- polynomial(c(0,1))
gGroups <- paste('g',1:k,sep='')
d <- data.frame(group=sample(gGroups,n,replace=TRUE),
                one=1,
                y=FALSE,
                stringsAsFactors=FALSE)
dTest <- data.frame(group=gGroups,
                    stringsAsFactors=FALSE)

ests <- function(d) {
  num <- aggregate(y~group,data=d,FUN=sum)
  den <- aggregate(one~group,data=d,FUN=sum)
  est <- num$y/den$one
  names(est) <- num$group
  est
}

naiveEst <- function(d) {
  est <- ests(d)
  as.numeric(est[d$group])
}

jackknifeEst <- function(d,jackDenom=1) {
  num <- aggregate(y~group,data=d,FUN=sum)
  numM <- num$y
  names(numM) <- num$group
  numV <- numM[d$group]
  den <- aggregate(one~group,data=d,FUN=sum)
  denM <- den$one
  names(denM) <- den$group
  denV <- denM[d$group]
  v <- as.numeric((numV-d$y/jackDenom)/(denV-1/jackDenom))
  v[is.na(v)|is.infinite(v)|is.nan(v)] <- 0
  v
}


estimateExpectedPrediction <- function(d,dTest) {
  if(all(d$y) || all(!d$y) || 
     ((max(d$est)-min(d$est))<=1.0e-5)) {
    return(dTest$est)
  }
  m <- glm(y~0+est,data=d,family=binomial(link='logit'))
  predict(m,newdata=dTest,type='response')
}

ys <- expand.grid( rep( list(0:1), n))==1
nPredEstMin <- 0
jPredEstMin <- 0
jPredEst2Min <- 0
nPredEstMax <- 0
jPredEstMax <- 0
jPredEst2Max <- 0
for(ii in seq_len(nrow(ys))) {
  y <- as.logical(ys[ii,])
  d$y <- y
  py <- probOn^(sum(y))*(1-probOn)^(length(y)-sum(y))
  est <- ests(d)
  dTest$est <- as.numeric(est[dTest$group])
  d$est <- naiveEst(d)
  nPred <- estimateExpectedPrediction(d,dTest)
  nPredEstMin <- nPredEstMin + min(nPred)*py
  nPredEstMax <- nPredEstMax + max(nPred)*py
  d$est <- jackknifeEst(d,1)
  jPred <- estimateExpectedPrediction(d,dTest)
  jPredEstMin <- jPredEstMin + min(jPred)*py
  jPredEstMax <- jPredEstMax + max(jPred)*py
  d$est <- jackknifeEst(d,2)
  jPred2 <- estimateExpectedPrediction(d,dTest)
  jPredEst2Min <- jPredEst2Min + min(jPred2)*py
  jPredEst2Max <- jPredEst2Max + max(jPred2)*py
}

print('naive prediction')
print(nPredEstMin)
print(nPredEstMax)

print('jackknife prediction')
print(jPredEstMin)
print(jPredEstMax)

print('jackknife 2 prediction')
print(jPredEstMin)
print(jPredEstMax)

print('ideal prediction')
print(probOn)

plotD <- data.frame(x=seq(0,1,by=0.01),
                    stringsAsFactors = FALSE)
plotD2 <- plotD
plotD2$what <- 'naive prediction'
plotD2$estMin <- as.function(nPredEstMin)(plotD$x)
plotD2$estMax <- as.function(nPredEstMax)(plotD$x)
plotD3 <- plotD
plotD3$what <- 'jackknife prediction'
plotD3$estMin <- as.function(jPredEstMin)(plotD$x)
plotD3$estMax <- as.function(jPredEstMax)(plotD$x)
plotD4 <- plotD
plotD4$what <- 'jackknife 2 prediction'
plotD4$estMin <- as.function(jPredEst2Min)(plotD$x)
plotD4$estMax <- as.function(jPredEst2Max)(plotD$x)
plotD <- rbind(plotD2,plotD3,plotD4)

ggplot(data=rbind(plotD2,plotD3),mapping=aes(x=x,ymin=estMin,ymax=estMax,
                              color=what,fill=what)) +
  geom_ribbon(alpha=0.5) +
  geom_abline() + 
  coord_fixed() +
  ggtitle(paste('predictions, n=',n))

ggplot(data=rbind(plotD3,plotD4),
       mapping=aes(x=x,ymin=estMin,ymax=estMax,
                              color=what,fill=what)) +
  geom_ribbon(alpha=0.5) +
  geom_abline() + 
  coord_fixed() +
  ggtitle(paste('predictions, n=',n))


plotR <- data.frame(x=seq(0,1,by=0.01),
                    stringsAsFactors = FALSE)
plotR1ratio <- as.function(probOn)(plotR$x)
plotR2 <- plotR
plotR2$what <- 'naive prediction'
plotR2$ratioMin <- as.function(nPredEstMin)(plotR$x)/plotR1ratio
plotR2$ratioMax <- as.function(nPredEstMax)(plotR$x)/plotR1ratio
plotR3 <- plotR
plotR3$what <- 'jackknife prediction'
plotR3$ratioMin <- as.function(jPredEstMin)(plotR$x)/plotR1ratio
plotR3$ratioMax <- as.function(jPredEstMax)(plotR$x)/plotR1ratio
plotR4 <- plotR
plotR4$what <- 'jackknife 2 prediction'
plotR4$ratioMin <- as.function(jPredEst2Min)(plotR$x)/plotR1ratio
plotR4$ratioMax <- as.function(jPredEst2Max)(plotR$x)/plotR1ratio

ggplot(data=rbind(plotR2,plotR3),
       mapping=aes(x=x,ymin=ratioMin,ymax=ratioMax,
                   color=what,fill=what)) +
  geom_ribbon(alpha=0.5) +
  geom_hline(yintercept=1) +
  ggtitle(paste('prediction ratios, n=',n))

ggplot(data=rbind(plotR3,plotR4),
       mapping=aes(x=x,ymin=ratioMin,ymax=ratioMax,
                   color=what,fill=what)) +
  geom_ribbon(alpha=0.5) +
  geom_hline(yintercept=1) +
  ggtitle(paste('prediction ratios, n=',n))

```

